<!DOCTYPE html>
<head>
  <title>Visualization of Air Quality (PM 10) in Delhi, India 2004-2015</title>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
  <script src="functions.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <style>
    body {
      font-family:"avenir next", Arial, sans-serif;
      font-size: 12px;
      color: #696969;
    }

    .ticks {
      font-size: 10px;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }

    .track-inset {
      stroke: #dcdcdc;
      stroke-width: 8px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: crosshair;
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width: 1.25px;
    }
  </style>
</head>

<body>
<h1 id="titles">Visualization of Air Quality (PM 10) in Delhi, India 2004-2015</h1>
<p>
  In this project we focus on visualizing and analyzing pollution data in Delhi over ten year, from 2004 to 2015 with a municipality ward level granularity.  We develop d3.js code along with HTML, CSS and other javascript libraries to achieve these visualizations. The pollution data is that PM10 levels in nine areas of Delhi.
</p>
<script>
var color_na = d3.rgb("#d4d4d4");
    // only works if array.length-1 is between 3 and 9 (d3 color scheme)
var quantiles = [0, 0.2, 0.4, 0.6, 0.8, 1];


var w = 558, ht = 600;
    var projection = d3.geoMercator()
        .scale(59932.932899877305)
        .center([77.09078699999999,28.643820032223946]) //projection center
        .translate([w/2,ht/2]) //translate to center the map in view
    var svg_map = d3.select("body").insert("svg")
                  .attr("id", "map")
                  .attr("height", ht)
                  .attr("width", w);
    //Generate paths based on projection
    var path = d3.geoPath()
    .projection(projection);
    //var path = d3.geoPath(d3.geoRobinson());


    var svg_map = d3.select("body").insert("svg")
                  .attr("id", "map")
                  .attr("height", ht)
                  .attr("width", w);
    
    // init legend container
    svg_map.append("g")
        .attr("class", "legend");
    svg_map.append("g")
        .attr("class", "legend_title")
        .append("text");

    // init bars container
    var margin = {top: 50, right:10, bottom: 100, left:30};
    var svgBarsWidth = 480 - margin.left - margin.right,
        svgBarsHeight = 200 - margin.top - margin.bottom;

    var x = d3.scaleBand()
                .rangeRound([0, svgBarsWidth])
                .padding(.05);
    var y = d3.scaleLinear().range([svgBarsHeight, 0]);

    var svg_bars = d3.select("body")
        .append("svg")
          .attr("id", "bars")
          .attr("width", svgBarsWidth + margin.left + margin.right)
          .attr("height", svgBarsHeight + margin.top + margin.bottom)
        .append("g")
          .attr("class", "bars")
          .attr("transform", "translate(" + margin.left + ", " + margin.top + ")");

</script>

<div id="slider"></div>
<script>
var dataset;


var formatDateIntoYear = d3.timeFormat("%Y");
var formatDate = d3.timeFormat("%b %Y");
var parseDate = d3.timeParse("%m/%d/%y");

var startDate = new Date("2004-10-10"),
    endDate = new Date("2007-02-02");

var margin = {top:0, right:250, bottom:0, left:350},
    width = 960,
    height = 100;

////////// slider //////////

var svgSlider = d3.select("#slider")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height);
    
var z = d3.scaleTime()
    .domain([startDate, endDate])
    .range([0, width])
    .clamp(true);

var slider = svgSlider.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", z.range()[0])
    .attr("x2", z.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() { update(z.invert(d3.event.x)); }));

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
    .data(z.ticks(10))
    .enter()
    .append("text")
    .attr("x", z)
    .attr("y", 10)
    .attr("text-anchor", "middle")
    .text(function(d) { return formatDateIntoYear(d); });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(formatDate(startDate))
    .attr("transform", "translate(0," + (-25) + ")")

////////// plot //////////

    
/*
d3.csv("circles.csv", prepare, function(data) {
  dataset = data;
  drawPlot(dataset);
})*/

d3.json("pollutiondata3.json", function(error, d) {

      if (error) throw error;

      let data_all = d['Pollution'];
      dataset = data_all;
      let data = data_all['Oct 2004'];
      let color = calcColorScale(data);

      // load map data and render it
      d3.json("delhi_wards5.geojson", function(error, geodata) {
        if (error) throw error;

        // init map
        svg_map.append("g")
          .attr("class", "features")
          .selectAll("path")
          .data(geodata.features)
          .enter().append("path")
            .attr("d", path)
            .attr("id", function(d) { return d.id; })
            .call(fillMap, color, data)
          .append("title")
            .call(setPathTitle, data);

        // init legend
        renderLegend(color, data);
        renderBars(color, data);
      }); // map data

      // was the slider used?
      /*d3.select("#year").on("input", function() {
          let upd_color = calcColorScale(data_all[this.value]);
          updateMap(upd_color, data_all[this.value]);
          renderLegend(upd_color, data_all[this.value]);
          renderBars(upd_color, data_all[this.value]);
      });*/

     
     // drawPlot(dataset);

    }); 




function update(h) {
  // update position and text of label according to slider scale
  handle.attr("cx", z(h));
  label
    .attr("x", z(h))
    .text(formatDate(h));


  // filter data set and redraw plot
  /*
  var newData = dataset.filter(function(d) {
    return d.date < h;
  })
  drawPlot(newData);
  */

  //d3.select(formatDate(h)).on("input", function() {
  let upd_color = calcColorScale(dataset[formatDate(h)]);
  updateMap(upd_color, dataset[formatDate(h)]);
  renderLegend(upd_color, dataset[formatDate(h)]);
  renderBars(upd_color, dataset[formatDate(h)]);
  //});


}
</script>

  <div class="row">
                    <div class="offset-right">
                        <div class="col-md-4"></div>
                            <div class="col-md-4">
                                <div class="createdByCard">
                                    <div class="cardInnerMargin">
                                        <div class="center-align">
                                            Created by Santosh Devarakonda in collabaration with Suresh K. Lodha. <br><br>
                                        </div>
                                     </div>
                                </div>
                            </div>
                        <div class="col-md-4"></div>
                    </div>
                </div>


<div class="row">
                    <div class="offset-left">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="cardInnerMargin">
                                    <span class="cardTitle">Submitted Files</span>
                                    <ul>
                                        <li>index.html</li>
                                        <li>function.js</li>
                                        <li>pollutiondata.json</li>
                                        <li>delhi_wards.json</li>
                                        <li>README</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="cardInnerMargin">
                                    <span class="cardTitle">Data Sources</span>
                                    <ul>
                                        <li><a href="https://data.gov.in/catalog/historical-daily-ambient-air-quality-data">Delhi pollution data</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="cardInnerMargin">
                                    <span class="cardTitle">Visual & Code Sources</span>
                                    <ul>
                                        <li><a href="https://github.com/santoshdns/msprj_delpollution">D3 API Reference</a></li>
                                        <li><a href="http://bl.ocks.org/d3noob/6eb506b129f585ce5c8a">Favorite Tooltip by d3noob</a></li>
                                        <li><a href="http://getbootstrap.com/">Bootstrap</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div> 
                    </div>        
                </div>
</body>